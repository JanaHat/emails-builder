let currentClient=null;const externalScriptCache=new Map;function loadExternalScript(e,t){if(t&&window[t])return Promise.resolve(window[t]);if(externalScriptCache.has(e))return externalScriptCache.get(e);const n=new Promise((n,a)=>{const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>n(!t||window[t]),o.onerror=()=>a(new Error(`Failed to load ${e}`)),document.head.appendChild(o)});return externalScriptCache.set(e,n),n}async function ensureExportDeps(){await loadExternalScript("/vendor/html2canvas/html2canvas.min.js","html2canvas"),await loadExternalScript("/vendor/jspdf/jspdf.umd.min.js","jspdf");const e=window.jspdf?.jsPDF,t=window.html2canvas;if(!e||!t)throw new Error("Export libraries failed to load");return{jsPDF:e,html2canvas:t}}function updateIframeHeight(e){if(!e)return;const t=e.contentDocument||e.contentWindow?.document;if(!t)return;const n=Math.max(t.body?.scrollHeight||0,t.documentElement?.scrollHeight||0);n>0&&(e.style.height=n+"px")}function syncIframeHeight(e){if(!e)return;const t=e.contentDocument||e.contentWindow?.document;if(!t)return;updateIframeHeight(e);Array.from(t.images||[]).forEach(t=>{t.complete||(t.addEventListener("load",()=>updateIframeHeight(e),{once:!0}),t.addEventListener("error",()=>updateIframeHeight(e),{once:!0}))});const n=performance.now(),a=()=>{updateIframeHeight(e),performance.now()-n<1e3&&requestAnimationFrame(a)};requestAnimationFrame(a)}function setPreviewLoading(e){const t=document.getElementById("email-preview");t&&t.classList.toggle("loading",e)}function applyClientTheme(e){e&&(document.body.dataset.client=e)}async function loadVariations(e){const t=document.getElementById(`campaign-list-${e}`);try{const n=await fetch(`/output/${currentClient}/${e}`);if(!n.ok)throw new Error("Failed to fetch languages");const a=await n.json();console.log(`Languages for ${e}:`,a),t.innerHTML=a.map(t=>`\n            <li>\n                <button class="side-panel-variations-btns" data-campaign="${e}" data-language="${t}"><img src="/assets/folder-small.png" alt="Language folder"/> ${t} </button>\n                <ul id="email-list-${e}-${t}"></ul>\n            </li>\n        `).join("")}catch(e){console.error("Error loading languages:",e)}}async function loadEmails(e,t){const n=document.getElementById(`email-list-${e}-${t}`);try{const a=await fetch(`/output/${currentClient}/${e}/${t}`);if(!a.ok)throw new Error("Failed to fetch emails");const o=await a.json();n.innerHTML=o.map(n=>`\n            <li class="email-list-item">\n                <button class="side-panel-emails-btns" data-campaign="${e}" data-language="${t}" data-email="${n}">\n                    <img src="/assets/html.png" alt="Email HTML"/> ${n}\n                </button>\n                <input type="checkbox" class="email-checkbox" value="${n}">\n            </li>\n        `).join("")}catch(e){console.error("Error loading emails:",e)}}function viewSpecificEmail(e,t,n,a){const o=document.querySelector(".email-title");o&&(o.innerHTML=`<h2>${t} - ${n}</h2>`);document.querySelectorAll(".side-panel-emails-btns").forEach(e=>e.classList.remove("active-email")),a&&a.classList.add("active-email");const i=document.getElementById("email-preview");setPreviewLoading(!0),i.innerHTML=`\n        <iframe id="email-iframe" src="/output/${currentClient}/${e}/${t}/${n}"\n            scrolling="no"\n            style="width: 100%; display: block;"></iframe>\n    `;const l=document.getElementById("email-iframe");l.onload=()=>{setTimeout(()=>{syncIframeHeight(l),setPreviewLoading(!1)},50)}}document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("campaign-list"),t=document.getElementById("client-select"),n=document.getElementById("client-title");async function a(){if(currentClient)try{const t=await fetch(`/output/${currentClient}`);if(!t.ok)throw new Error("Failed to fetch campaigns");const n=await t.json();if(console.log("campaigns:",n),!Array.isArray(n)||0===n.length)return void(e.innerHTML="<li>No campaigns found</li>");e.innerHTML=n.map(e=>`\n                <li>\n                    <button class="side-panel-campaigns-btns" data-campaign="${e.key}"><img src="/assets/folder.png" alt="Campaign folder"/> ${e.name||e.key} </button>\n                    <ul id="campaign-list-${e.key}"></ul>\n                </li>\n            `).join("")}catch(e){console.error("Error loading campaigns:",e)}}t.addEventListener("change",async()=>{currentClient=t.value;const o=t.options[t.selectedIndex];n.textContent=o?.textContent||currentClient,applyClientTheme(currentClient),e.innerHTML="",await a()}),e.addEventListener("click",async e=>{const t=e.target.closest(".side-panel-campaigns-btns");if(t){const e=t.dataset.campaign;return void(e&&await loadVariations(e))}const n=e.target.closest(".side-panel-variations-btns");if(n){const{campaign:e,language:t}=n.dataset;return void(e&&t&&await loadEmails(e,t))}const a=e.target.closest(".side-panel-emails-btns");if(a){const{campaign:e,language:t,email:n}=a.dataset;e&&t&&n&&viewSpecificEmail(e,t,n,a)}}),async function(){try{const o=await fetch("/clients");if(!o.ok)throw new Error("Failed to fetch clients");const i=await o.json();t.innerHTML=i.map(e=>`\n                <option value="${e.key}">${e.name||e.key}</option>\n            `).join("");const l=i.length<=1,c=document.querySelector('label[for="client-select"]');if(t.disabled=l,t.setAttribute("aria-disabled",l?"true":"false"),t.style.display=l?"none":"",c&&(c.style.display=l?"none":""),currentClient=t.value||i[0]?.key||null,currentClient){const e=i.find(e=>e.key===currentClient);n.textContent=e?.name||currentClient,applyClientTheme(currentClient),await a()}else e.innerHTML=""}catch(e){console.error("Error loading clients:",e)}}()}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".email-wrapper"),t=document.getElementById("screen-mobile-xs"),n=document.getElementById("screen-mobile-s"),a=document.getElementById("screen-mobile-m"),o=document.getElementById("screen-desktop");t.addEventListener("click",()=>{e.style.width="275px",e.style.height="auto",e.style.overflow="hidden",setTimeout(()=>syncIframeHeight(document.getElementById("email-iframe")),50)}),n.addEventListener("click",()=>{e.style.width="325px",e.style.height="auto",e.style.overflow="hidden",setTimeout(()=>syncIframeHeight(document.getElementById("email-iframe")),50)}),a.addEventListener("click",()=>{e.style.width="375px",e.style.height="auto",e.style.overflow="hidden",setTimeout(()=>syncIframeHeight(document.getElementById("email-iframe")),50)}),o.addEventListener("click",()=>{e.style.width="600px",e.style.height="auto",setTimeout(()=>syncIframeHeight(document.getElementById("email-iframe")),50)})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".screen-view-btn");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active-screen")),t.classList.add("active-screen")})})});const exportPdfButton=document.getElementById("export-pdf");exportPdfButton&&exportPdfButton.addEventListener("click",async()=>{const e=document.querySelectorAll(".email-checkbox:checked");if(0===e.length)return void alert("Please select at least one email to export.");const{jsPDF:t,html2canvas:n}=await ensureExportDeps(),a=new t;for(const t of e){const e=t.value,o=t.closest(".email-list-item")?.querySelector(".side-panel-emails-btns");if(!o){console.error(`No button found for email: ${e}`);continue}const i=o.dataset.campaign,l=o.dataset.language;if(!i||!l)continue;const c=await fetch(`/output/${currentClient}/${i}/${l}/${e}`);if(!c.ok){console.error(`Failed to load email: ${e}`);continue}const s=await c.text(),r=document.createElement("div");r.style.position="absolute",r.style.left="-9999px",r.style.width="600px",r.innerHTML=s,document.body.appendChild(r);const d=await n(r,{scale:2}),m=d.toDataURL("image/png");document.body.removeChild(r);const u=190,p=d.height*u/d.width;a.addImage(m,"PNG",10,10,u,p),a.addPage()}a.deletePage(a.internal.pages.length),a.save("selected-emails.pdf")});const exportPngButton=document.getElementById("export-png");exportPngButton&&exportPngButton.addEventListener("click",async()=>{const e=document.querySelectorAll(".email-checkbox:checked");if(0===e.length)return void alert("Please select at least one email to export.");const{html2canvas:t}=await ensureExportDeps();for(const n of e){const e=n.value,a=n.closest(".email-list-item")?.querySelector(".side-panel-emails-btns");if(!a){console.error(`No button found for email: ${e}`);continue}const o=a.dataset.campaign,i=a.dataset.language;if(!o||!i)continue;const l=await fetch(`/output/${currentClient}/${o}/${i}/${e}`);if(!l.ok){console.error(`Failed to load email: ${e}`);continue}const c=await l.text(),s=document.createElement("div");s.style.position="absolute",s.style.left="-9999px",s.style.width="600px",s.innerHTML=c,document.body.appendChild(s);const r=(await t(s,{scale:2})).toDataURL("image/png");document.body.removeChild(s);const d=document.createElement("a");d.href=r,d.download=`${e.replace(".html","")}.png`,d.click()}alert("Selected emails exported as PNG!")});